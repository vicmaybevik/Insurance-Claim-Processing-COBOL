IDENTIFICATION DIVISION.
PROGRAM-ID. CLAIM-PROCESS.
ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT CLAIM-FILE ASSIGN TO "claims.dat"
        ORGANIZATION IS LINE SEQUENTIAL
        FILE STATUS IS WS-CLAIM-FILE-STATUS.
    SELECT REPORT-FILE ASSIGN TO "report.out"
        ORGANIZATION IS LINE SEQUENTIAL
        FILE STATUS IS WS-REPORT-FILE-STATUS.
DATA DIVISION.
FILE SECTION.
FD CLAIM-FILE.
01 CLAIM-RECORD.
    05 CLAIM-ID           PIC X(10).
    05 CUSTOMER-NAME      PIC X(13).
    05 CLAIM-AMOUNT       PIC 9(5)V99.
    05 FILLER             PIC X.
    05 CLAIM-STATE        PIC XX.
FD REPORT-FILE.
01 REPORT-RECORD          PIC X(80).
WORKING-STORAGE SECTION.
01 WS-FLAGS.
    05 WS-EOF-FLAG        PIC X VALUE 'N'.
        88 WS-EOF             VALUE 'Y'.
01 WS-COUNTERS.
    05 WS-TOTAL-CLAIMS    PIC 9(5) VALUE 0.
    05 WS-VALID-CLAIMS    PIC 9(5) VALUE 0.
    05 WS-REJECTED-CLAIMS PIC 9(5) VALUE 0.
01 WS-STATE-COUNTERS.
    05 WS-NH-CLAIMS       PIC 9(5) VALUE 0.
    05 WS-ME-CLAIMS       PIC 9(5) VALUE 0.
    05 WS-CT-CLAIMS       PIC 9(5) VALUE 0.
01 WS-CLAIM-STATUS        PIC X(10).
01 WS-ERROR-MESSAGE       PIC X(50).
01 WS-CLAIM-FILE-STATUS   PIC XX.
01 WS-REPORT-FILE-STATUS  PIC XX.
01 WS-FORMATTED-AMOUNT    PIC ZZ,ZZZ.99.
PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM 100-INITIALIZE
    PERFORM 200-PROCESS-CLAIMS UNTIL WS-EOF
    PERFORM 300-GENERATE-REPORT
    PERFORM 400-CLEANUP
    STOP RUN.
100-INITIALIZE.
    OPEN INPUT CLAIM-FILE
    IF WS-CLAIM-FILE-STATUS NOT = "00"
       DISPLAY "Error opening input file: claims.dat"
       DISPLAY "File status: " WS-CLAIM-FILE-STATUS
       PERFORM 400-CLEANUP
       STOP RUN
    END-IF
    OPEN OUTPUT REPORT-FILE
    IF WS-REPORT-FILE-STATUS NOT = "00"
       DISPLAY "Error opening output file: report.out"
       DISPLAY "File status: " WS-REPORT-FILE-STATUS
       PERFORM 400-CLEANUP
       STOP RUN
    END-IF.
200-PROCESS-CLAIMS.
    READ CLAIM-FILE
        AT END
            SET WS-EOF TO TRUE
        NOT AT END
            ADD 1 TO WS-TOTAL-CLAIMS
            PERFORM 210-VALIDATE-CLAIM
            PERFORM 220-ADJUDICATE-CLAIM.
210-VALIDATE-CLAIM.
    MOVE SPACES TO WS-ERROR-MESSAGE
    MOVE CLAIM-AMOUNT TO WS-FORMATTED-AMOUNT
    DISPLAY "Debug: CLAIM-ID = '" CLAIM-ID "'"
    DISPLAY "Debug: CUSTOMER-NAME = '" CUSTOMER-NAME "'"
    DISPLAY "Debug: CLAIM-AMOUNT = '" WS-FORMATTED-AMOUNT "'"
    DISPLAY "Debug: CLAIM-STATE = '" CLAIM-STATE "'"
    IF CLAIM-ID = SPACES
       MOVE "Empty CLAIM-ID" TO WS-ERROR-MESSAGE
    END-IF
    IF CLAIM-AMOUNT <= 0 OR CLAIM-AMOUNT > 99999.99
       MOVE "Invalid claim amount" TO WS-ERROR-MESSAGE
    END-IF
    IF CLAIM-STATE = SPACES
       MOVE "Empty state code" TO WS-ERROR-MESSAGE
    ELSE IF CLAIM-STATE NOT = "NH" AND 
            CLAIM-STATE NOT = "ME" AND 
            CLAIM-STATE NOT = "CT"
       MOVE "Invalid state code" TO WS-ERROR-MESSAGE
    END-IF
    IF WS-ERROR-MESSAGE = SPACES
       MOVE "VALID" TO WS-CLAIM-STATUS
       ADD 1 TO WS-VALID-CLAIMS
    ELSE
       MOVE "REJECTED" TO WS-CLAIM-STATUS
       ADD 1 TO WS-REJECTED-CLAIMS
    END-IF
    DISPLAY "Validating claim: " CLAIM-ID " - " WS-CLAIM-STATUS
    IF WS-ERROR-MESSAGE NOT = SPACES
       DISPLAY "Error: " WS-ERROR-MESSAGE.
220-ADJUDICATE-CLAIM.
    IF WS-CLAIM-STATUS = "VALID"
        EVALUATE CLAIM-STATE
            WHEN "NH"
                ADD 1 TO WS-NH-CLAIMS
            WHEN "ME"
                ADD 1 TO WS-ME-CLAIMS
            WHEN "CT"
                ADD 1 TO WS-CT-CLAIMS
        END-EVALUATE
        DISPLAY "Adjudicating claim: " CLAIM-ID " - Approved"
    ELSE
        DISPLAY "Adjudicating claim: " CLAIM-ID " - Rejected"
    END-IF.
300-GENERATE-REPORT.
    DISPLAY "Generating report..."
    
    MOVE "INSURANCE CLAIM PROCESSING REPORT" TO REPORT-RECORD
    WRITE REPORT-RECORD
    MOVE SPACES TO REPORT-RECORD
    WRITE REPORT-RECORD
    
    MOVE SPACES TO REPORT-RECORD
    STRING "Total Claims: " WS-TOTAL-CLAIMS 
           INTO REPORT-RECORD
    WRITE REPORT-RECORD
    
    MOVE SPACES TO REPORT-RECORD
    STRING "Valid Claims: " WS-VALID-CLAIMS 
           INTO REPORT-RECORD
    WRITE REPORT-RECORD
    
    MOVE SPACES TO REPORT-RECORD
    STRING "Rejected Claims: " WS-REJECTED-CLAIMS 
           INTO REPORT-RECORD
    WRITE REPORT-RECORD
    
    MOVE SPACES TO REPORT-RECORD
    WRITE REPORT-RECORD
    
    MOVE "State-wise Breakdown:" TO REPORT-RECORD
    WRITE REPORT-RECORD
    
    MOVE SPACES TO REPORT-RECORD
    STRING "NH: " WS-NH-CLAIMS INTO REPORT-RECORD
    WRITE REPORT-RECORD
    
    MOVE SPACES TO REPORT-RECORD
    STRING "ME: " WS-ME-CLAIMS INTO REPORT-RECORD
    WRITE REPORT-RECORD
    
    MOVE SPACES TO REPORT-RECORD
    STRING "CT: " WS-CT-CLAIMS INTO REPORT-RECORD
    WRITE REPORT-RECORD.
400-CLEANUP.
    CLOSE CLAIM-FILE
    CLOSE REPORT-FILE.
    
